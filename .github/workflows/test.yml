name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Check coverage
        run: |
          FUNC_OUTPUT=$(go tool cover -func=coverage.out)
          TOTAL_COVERAGE=$(echo "$FUNC_OUTPUT" | grep "^total:" | awk '{print $3}' | sed 's/%//')

          if [ "$(echo "$TOTAL_COVERAGE < 95" | bc)" -eq 1 ]; then
            STATUS="FAILED"
            ICON=":x:"
          else
            STATUS="PASSED"
            ICON=":white_check_mark:"
          fi

          {
            echo "## Code Coverage Report"
            echo ""
            echo "**Status: ${STATUS}** ${ICON} â€” Total coverage: **${TOTAL_COVERAGE}%** (threshold: 95%)"
            echo ""
            echo "### Coverage by Function"
            echo ""
            echo "| File | Function | Coverage |"
            echo "|------|----------|----------|"
            echo "$FUNC_OUTPUT" | grep -v "^total:" | while IFS= read -r line; do
              FILE=$(echo "$line" | awk '{print $1}' | sed 's|github.com/josegonzalez/helm-ttl/||' | sed 's/:$//')
              FUNC=$(echo "$line" | awk '{print $2}')
              COV=$(echo "$line" | awk '{print $3}')
              echo "| \`${FILE}\` | \`${FUNC}\` | ${COV} |"
            done
            echo ""
            echo "---"
            echo "| **Total** | | **${TOTAL_COVERAGE}%** |"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$STATUS" = "FAILED" ]; then
            echo "Coverage is below 95%!"
            exit 1
          fi

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout 5m --verbose
